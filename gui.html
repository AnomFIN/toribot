<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÅ Tori Annataan Bot - Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="background-logo" id="background-logo"></div>
    
    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>üéÅ ToriBot</h2>
            <button class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <ul class="sidebar-menu">
            <li>
                <a href="#" class="nav-link active" data-page="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span data-i18n="dashboard">Dashboard</span>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" data-page="products">
                    <i class="fas fa-th-large"></i>
                    <span data-i18n="products">Tuotteet</span>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" data-page="products-list">
                    <i class="fas fa-list"></i>
                    <span data-i18n="products_list">Liistan√§kym√§</span>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" data-page="analytics">
                    <i class="fas fa-chart-line"></i>
                    <span data-i18n="analytics">Analytiikka</span>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" data-page="settings">
                    <i class="fas fa-cog"></i>
                    <span data-i18n="settings">Asetukset</span>
                </a>
            </li>
        </ul>
        
        <div class="sidebar-footer">
            <div class="language-switcher">
                <select id="language-select-sidebar">
                    <option value="fi">üá´üáÆ FI</option>
                    <option value="en">üá∫üá∏ EN</option>
                </select>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="main-content" id="main-content">
        <header class="top-header">
            <div class="header-left">
                <h1 id="page-title" data-i18n="dashboard">Dashboard</h1>
            </div>
            <div class="header-right">
                <button id="refresh-btn" class="btn btn-primary">
                    <i class="fas fa-sync-alt"></i>
                    <span data-i18n="refresh">P√§ivit√§</span>
                </button>
                <span class="last-update-header">
                    <i class="fas fa-clock"></i>
                    <span data-i18n="last_updated">Viimeksi p√§ivitetty:</span>
                    <span id="last-update-time" data-i18n="never">Ei koskaan</span>
                </span>
            </div>
        </header>

        <!-- Dashboard Page -->
        <div class="page active" id="dashboard-page">
            <div class="dashboard-grid">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="total-products">0</h3>
                            <p data-i18n="total_products">Tuotteita yhteens√§</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="valued-products">0</h3>
                            <p data-i18n="valued_products">Arvostettuja tuotteita</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-euro-sign"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="total-value">0‚Ç¨</h3>
                            <p data-i18n="total_estimated_value">Arvioitu kokonaisarvo</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-images"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="total-images">0</h3>
                            <p data-i18n="total_images">Kuvia ladattu</p>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h3 data-i18n="quick_actions">Pikavalinnat</h3>
                    <div class="actions-grid">
                        <button class="action-card" id="fetch-btn">
                            <i class="fas fa-download"></i>
                            <span data-i18n="fetch_products">Hae tuotteet</span>
                        </button>
                        <button class="action-card" id="save-btn">
                            <i class="fas fa-save"></i>
                            <span data-i18n="save_products">Tallenna CSV</span>
                        </button>
                        <button class="action-card" id="run-valuations-dash">
                            <i class="fas fa-robot"></i>
                            <span data-i18n="run_valuations">Suorita arvostukset</span>
                        </button>
                        <button class="action-card" id="fetch-images-dash">
                            <i class="fas fa-images"></i>
                            <span data-i18n="fetch_images">Hae kuvat</span>
                        </button>
                    </div>
                </div>
                
                <!-- Recent Products -->
                <div class="recent-products">
                    <h3 data-i18n="recent_products">Viimeisimm√§t tuotteet</h3>
                    <div class="products-preview" id="recent-products-list">
                        <div class="loading-card">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span data-i18n="loading">Ladataan...</span>
                        </div>
                    </div>
                </div>
                
                <!-- System Status -->
                <div class="system-status">
                    <h3 data-i18n="system_status">J√§rjestelm√§n tila</h3>
                    <div class="status-items">
                        <div class="status-item">
                            <i class="fas fa-server status-icon"></i>
                            <span data-i18n="bot_status">Botin tila:</span>
                            <span class="status-value" id="bot-status">K√§ynniss√§</span>
                        </div>
                        <div class="status-item">
                            <i class="fas fa-wifi status-icon"></i>
                            <span data-i18n="connection_status">Yhteys:</span>
                            <span class="status-value" id="connection-status">Toimii</span>
                        </div>
                        <div class="status-item">
                            <i class="fas fa-brain status-icon"></i>
                            <span data-i18n="openai_status">OpenAI:</span>
                            <span class="status-value" id="openai-status">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Real-time Logs -->
                <div class="real-time-logs">
                    <div class="logs-header">
                        <h3 data-i18n="real_time_logs">Reaaliaikaiset logit</h3>
                        <div class="logs-actions">
                            <button class="btn btn-secondary btn-sm" id="refresh-logs-btn">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-secondary btn-sm" id="clear-logs-btn">
                                <i class="fas fa-trash"></i>
                                <span data-i18n="clear_logs">Tyhjenn√§</span>
                            </button>
                        </div>
                    </div>
                    <div class="logs-container" id="logs-container">
                        <div class="log-line">
                            <span class="log-timestamp">[K√§ynnistettiin]</span>
                            <span class="log-level log-info">[INFO]</span>
                            <span class="log-message">ToriBot k√§ynniss√§ - seurataan Tori.fi ilmaisia tuotteita...</span>
                        </div>
                        <div class="log-note">
                            <i class="fas fa-info-circle"></i>
                            <span data-i18n="logs_description">Reaaliaikaiset logit n√§kyv√§t t√§√§ll√§ kun botti on aktiivinen</span>
                        </div>
                        <div class="log-note">
                            <i class="fas fa-folder-open"></i>
                            <span>Yksityiskohtaiset logit: debug/ kansiossa</span>
                        </div>
                        <div class="log-info-section">
                            <h4><i class="fas fa-question-circle"></i> Reaaliaikaisen streaming tietoa</h4>
                            <p><strong>Nykyinen tilanne:</strong> Simuloidut logit (demo-tilassa)</p>
                            <p><strong>Reaaliaikainen streaming vaatii:</strong></p>
                            <ul>
                                <li>üîó WebSocket-yhteys backend-palvelimeen</li>
                                <li>üìÅ Reaaliaikainen debug/ kansion tiedostojen seuranta</li>
                                <li>üîÑ Log-streaming API endpoint (/api/logs/stream)</li>
                                <li>‚ö° Tail-toiminnallisuus log-tiedostoille</li>
                            </ul>
                            <p><strong>Implementointi edellytt√§√§:</strong></p>
                            <ul>
                                <li>Backend muutoksia Python-koodiin (toribot.py)</li>
                                <li>Uusia riippuvuuksia: python-socketio, watchdog</li>
                                <li>Frontin WebSocket-asiakaskoodi</li>
                            </ul>
                            <p class="note-highlight">
                                üí° <strong>V√§liaikaisesti:</strong> Todellisia logeja voi seurata debug/ kansiosta tai 
                                k√§ytt√§√§ terminal-komentoa: <code>tail -f debug/*.log</code>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Products Grid Page -->
        <div class="page" id="products-page">
            <div class="page-header">
                <div class="view-controls">
                    <button class="btn btn-secondary" id="grid-view-btn">
                        <i class="fas fa-th"></i>
                        <span data-i18n="grid_view">Ruudukko</span>
                    </button>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="product-search" placeholder="Hae tuotteita..." data-i18n-placeholder="search_products">
                    </div>
                    <select id="sort-products">
                        <option value="newest" data-i18n-option="newest">Uusimmat ensin</option>
                        <option value="oldest" data-i18n-option="oldest">Vanhimmat ensin</option>
                        <option value="valued" data-i18n-option="valued">Arvostetuimmat</option>
                        <option value="price-high" data-i18n-option="price_high">Korkein arvo</option>
                        <option value="price-low" data-i18n-option="price_low">Matalin arvo</option>
                    </select>
                </div>
            </div>
            
            <div class="products-grid" id="products-grid">
                <div class="loading-placeholder">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span data-i18n="loading_products">Ladataan tuotteita...</span>
                </div>
            </div>
        </div>
                <div class="stat-item">
                    <span class="stat-label" data-i18n="total_items">Tuotteita yhteens√§:</span>
                    <span class="stat-value" id="total-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label" data-i18n="last_updated">Viimeksi p√§ivitetty:</span>
                    <span class="stat-value" id="last-update" data-i18n="never">Ei koskaan</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label" data-i18n="auto_refresh">Automaattip√§ivitys:</span>
                    <span class="stat-value">30s</span>
                </div>
                <div class="stat-item">
                    <button id="valuate-btn" class="action-btn" data-i18n="run_valuations">ü§ñ Suorita arvostukset</button>
                </div>
                <div class="stat-item">
                    <button id="fetch-images-btn" class="action-btn" data-i18n="fetch_images">üñºÔ∏è Hae kuvat</button>
                </div>
            </div>

        <!-- Analytics Page -->
        <div class="page" id="analytics-page">
            <div class="analytics-grid">
                <div class="chart-card">
                    <h3 data-i18n="products_over_time">Tuotteet ajan my√∂t√§</h3>
                    <div class="chart-placeholder">
                        <canvas id="products-chart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3 data-i18n="value_distribution">Arvojen jakauma</h3>
                    <div class="chart-placeholder">
                        <canvas id="value-chart"></canvas>
                    </div>
                </div>
                
                <div class="analytics-stats">
                    <h3 data-i18n="detailed_statistics">Yksityiskohtaiset tilastot</h3>
                    <div class="analytics-list">
                        <div class="analytics-item">
                            <span data-i18n="avg_value">Keskiarvo:</span>
                            <span id="avg-value">0‚Ç¨</span>
                        </div>
                        <div class="analytics-item">
                            <span data-i18n="highest_value">Korkein arvo:</span>
                            <span id="highest-value">0‚Ç¨</span>
                        </div>
                        <div class="analytics-item">
                            <span data-i18n="most_common_location">Yleisin sijainti:</span>
                            <span id="common-location">-</span>
                        </div>
                        <div class="analytics-item">
                            <span data-i18n="success_rate">Arvostusprosentti:</span>
                            <span id="success-rate">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                <table id="products-table">
                    <thead>
                        <tr>
                            <th data-i18n="images">Kuvat</th>
                            <th data-i18n="title">Otsikko</th>
                            <th data-i18n="description">Kuvaus</th>
                            <th data-i18n="location">Sijainti</th>
                            <th data-i18n="seller">Myyj√§</th>
                            <th data-i18n="valuation">Arvostus</th>
                            <th data-i18n="added">Lis√§tty</th>
                            <th data-i18n="link">Linkki</th>
                        </tr>
                    </thead>
                    <tbody id="products-body">
                        <tr>
                            <td colspan="8" class="loading" data-i18n="loading_products">Ladataan tuotteita...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="no-products" id="no-products" style="display: none;">
                <p data-i18n="no_products">Tuotteita ei l√∂ytynyt viel√§. Botti aloittaa seurannan pian.</p>
            </div>
        </div>

        <!-- Settings Page -->
        <div class="page" id="settings-page">
            <div class="settings-container">
                <h2 data-i18n="bot_settings">Botin asetukset</h2>
                
                <div class="settings-section">
                    <h3>üìä <span data-i18n="general_settings">Yleiset asetukset</span></h3>
                    <div class="form-group">
                        <label data-i18n="language">Kieli:</label>
                        <select id="language-select">
                            <option value="fi">Suomi</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>üé® <span data-i18n="logo_settings">Logon asetukset</span></h3>
                    <div class="form-group">
                        <label data-i18n="logo_file">Logotiedosto:</label>
                        <input type="file" id="logo-file" accept="image/*">
                        <button type="button" id="clear-logo-btn" class="secondary-btn" style="margin-top: 10px;">
                            <span data-i18n="clear_logo">üóëÔ∏è Poista logo</span>
                        </button>
                        <small data-i18n="logo_file_desc">Valitse taustakuvaksi k√§ytett√§v√§ logo (.png, .jpg, .svg)</small>
                    </div>
                    <div class="form-group">
                        <label data-i18n="logo_url">Tai anna kuvan URL-osoite:</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="url" id="logo-url" placeholder="https://example.com/logo.png" style="flex: 1;">
                            <button type="button" id="load-logo-url-btn" class="secondary-btn">
                                <span data-i18n="load_url">üì• Lataa</span>
                            </button>
                        </div>
                        <small data-i18n="logo_url_desc">Lataa logo suoraan URL-osoitteesta</small>
                    </div>
                    <div class="form-group">
                        <label data-i18n="logo_opacity">L√§pin√§kyvyys:</label>
                        <input type="range" id="logo-opacity" min="0" max="1" step="0.01" value="0.1">
                        <span class="range-value" id="opacity-value">0.1</span>
                    </div>
                    <div class="form-group">
                        <label data-i18n="logo_blur">Sumennus:</label>
                        <input type="range" id="logo-blur" min="0" max="20" step="0.5" value="0">
                        <span class="range-value" id="blur-value">0px</span>
                    </div>
                    <div class="form-group">
                        <label data-i18n="logo_position">Sijainti:</label>
                        <select id="logo-position">
                            <option value="center" data-i18n-option="center">Keskell√§</option>
                            <option value="top left" data-i18n-option="top_left">Vasemmalla ylh√§√§ll√§</option>
                            <option value="top right" data-i18n-option="top_right">Oikealla ylh√§√§ll√§</option>
                            <option value="bottom left" data-i18n-option="bottom_left">Vasemmalla alhaalla</option>
                            <option value="bottom right" data-i18n-option="bottom_right">Oikealla alhaalla</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="logo_size">Koko:</label>
                        <select id="logo-size">
                            <option value="contain" data-i18n-option="contain">Mahtuu kokonaan</option>
                            <option value="cover" data-i18n-option="cover">Peitt√§√§ alueen</option>
                            <option value="50%" data-i18n-option="small">Pieni (50%)</option>
                            <option value="75%" data-i18n-option="medium">Keskikokoinen (75%)</option>
                            <option value="100%" data-i18n-option="large">Suuri (100%)</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>ÔøΩ <span data-i18n="tori_login_settings">Tori.fi kirjautuminen</span></h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="tori_login_enabled">
                            <span data-i18n="enable_tori_login">Aktivoi automaattinen kirjautuminen</span>
                        </label>
                        <small data-i18n="tori_login_desc">Botin kirjautuminen Tori.fi-palveluun parantaa hakutuloksia</small>
                    </div>
                    <div class="form-group">
                        <label data-i18n="tori_username">K√§ytt√§j√§tunnus/S√§hk√∂posti:</label>
                        <input type="text" id="tori_username" placeholder="kayttaja@example.com" autocomplete="username">
                        <small data-i18n="tori_username_desc">Tori.fi-tilisi k√§ytt√§j√§tunnus tai s√§hk√∂postiosoite</small>
                    </div>
                    <div class="form-group">
                        <label data-i18n="tori_password">Salasana:</label>
                        <input type="password" id="tori_password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
                        <small data-i18n="tori_password_desc">Tori.fi-tilisi salasana (tallennetaan turvallisesti)</small>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="tori_remember_session">
                            <span data-i18n="remember_session">Muista kirjautuminen</span>
                        </label>
                        <small data-i18n="remember_session_desc">S√§√§st√§√§ istunnon uudelleenk√§ytt√∂√§ varten</small>
                    </div>
                    <div class="form-group">
                        <button id="test-login-btn" class="secondary-btn" type="button">
                            <span data-i18n="test_login">üß™ Testaa kirjautuminen</span>
                        </button>
                        <small data-i18n="test_login_desc">Testaa kirjautumistiedot ennen tallennusta</small>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>ÔøΩüìä <span data-i18n="general_settings">Yleiset asetukset</span></h3>
                    <div class="form-group">
                        <label data-i18n="poll_interval">Tarkistusv√§li (sekunnit):</label>
                        <input type="number" id="poll_interval" min="10" value="60">
                        <small data-i18n="poll_interval_desc">Kuinka usein tarkistetaan uusia tuotteita (min: 10s)</small>
                    </div>
                    <div class="form-group">
                        <label data-i18n="request_timeout">Pyynt√∂jen aikakatkaisu (sekunnit):</label>
                        <input type="number" id="timeout" min="1" value="15">
                    </div>
                    <div class="form-group">
                        <label data-i18n="max_retries">Uudelleenyritysten maksimim√§√§r√§:</label>
                        <input type="number" id="max_retries" min="0" max="5" value="2">
                    </div>
                    <div class="form-group">
                        <label data-i18n="listing_url">Listauksen URL:</label>
                        <input type="text" id="listing_url" style="width: 100%;">
                    </div>
                </div>

                <div class="settings-section">
                    <h3>üñºÔ∏è <span data-i18n="image_settings">Kuvien asetukset</span></h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="images_enabled" checked>
                            <span data-i18n="enable_image_download">Aktivoi kuvien lataus</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label data-i18n="max_images">Kuvia tuotetta kohden enint√§√§n:</label>
                        <input type="number" id="max_images" min="1" max="10" value="5">
                    </div>
                </div>

                <div class="settings-section">
                    <h3>ü§ñ <span data-i18n="openai_settings">OpenAI asetukset</span></h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="openai_enabled">
                            <span data-i18n="enable_valuations">Aktivoi OpenAI arvostukset</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label data-i18n="api_key">API-avain:</label>
                        <input type="password" id="openai_key" placeholder="sk-...">
                        <small data-i18n="api_key_desc">Tallennetaan turvallisesti settings.json tiedostoon</small>
                    </div>
                    <div class="form-group">
                        <label data-i18n="model">Malli:</label>
                        <input type="text" id="openai_model" value="gpt-4o-mini">
                    </div>
                    <div class="form-group">
                        <label data-i18n="base_url">Perus-URL:</label>
                        <input type="text" id="openai_base_url" value="https://api.openai.com/v1">
                    </div>
                    <div class="form-group">
                        <label data-i18n="valuation_interval">Arvostusv√§li (minuutit):</label>
                        <input type="number" id="valuation_interval" min="10" value="60">
                        <small data-i18n="valuation_interval_desc">Kuinka usein automaattiset arvostukset suoritetaan</small>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>üåê <span data-i18n="server_settings">Palvelimen asetukset</span></h3>
                    <div class="form-group">
                        <label data-i18n="host">Is√§nt√§:</label>
                        <input type="text" id="server_host" value="127.0.0.1">
                    </div>
                    <div class="form-group">
                        <label data-i18n="port">Portti:</label>
                        <input type="number" id="server_port" min="1024" max="65535" value="8787">
                        <small data-i18n="restart_required">Vaatii uudelleenk√§ynnistyksen</small>
                    </div>
                </div>

                <div class="button-group">
                    <button id="save-settings-btn" class="save-btn" data-i18n="save_settings">üíæ Tallenna asetukset</button>
                    <button id="load-settings-btn" class="secondary-btn" data-i18n="reload_settings">üîÑ Lataa asetukset uudelleen</button>
                </div>

                <div id="settings-message" class="message"></div>
            </div>
        </div>
    </div>
    
    <!-- Mobile overlay -->
    <div class="mobile-overlay" id="mobile-overlay"></div>

    <script>
        const REFRESH_INTERVAL = 30000;
        let currentPage = 'dashboard';
        let currentLanguage = 'fi';
        let currentTab = 'products';
        let allProducts = [];
        
        // Navigation handling
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected page
            const page = document.getElementById(pageId + '-page');
            if (page) {
                page.classList.add('active');
                currentPage = pageId;
                
                // Update page title
                const title = document.getElementById('page-title');
                const key = pageId.replace('-', '_');
                title.textContent = translations[currentLanguage][key] || pageId;
                
                // Add active class to corresponding nav link
                const navLink = document.querySelector(`[data-page="${pageId}"]`);
                if (navLink) {
                    navLink.classList.add('active');
                }
                
                // Load page-specific data
                loadPageData(pageId);
            }
        }
        
        // Load page-specific data
        function loadPageData(pageId) {
            switch (pageId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'products':
                    loadProductsGrid();
                    break;
                case 'products-list':
                    loadProductsList();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }
        
        // Navigation event listeners
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = link.dataset.page;
                showPage(pageId);
            });
        });
        
        // Sidebar toggle
        document.getElementById('sidebar-toggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('collapsed');
            document.getElementById('main-content').classList.toggle('expanded');
        });
        
        // Mobile overlay
        document.getElementById('mobile-overlay').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('mobile-open');
            document.getElementById('mobile-overlay').classList.remove('active');
        });
        
        // Translations
        const translations = {
            fi: {
                dashboard: 'Dashboard',
                products: 'Tuotteet',
                products_list: 'Listan√§kym√§',
                analytics: 'Analytiikka',
                settings: 'Asetukset',
                refresh: 'P√§ivit√§',
                total_products: 'Tuotteita yhteens√§',
                valued_products: 'Arvostettuja tuotteita',
                total_estimated_value: 'Arvioitu kokonaisarvo',
                total_images: 'Kuvia ladattu',
                quick_actions: 'Pikavalinnat',
                logs: 'Logit',
                view_logs: 'N√§yt√§ logit',
                clear_logs: 'Tyhjenn√§ logit',
                logs_description: 'Botin toiminta ja tapahtumat',
                real_time_logs: 'Reaaliaikaiset logit',
                export_data: 'Vie tiedot',
                clear_old: 'Siivoa vanhat',
                recent_products: 'Viimeisimm√§t tuotteet',
                system_status: 'J√§rjestelm√§n tila',
                bot_status: 'Botin tila',
                connection_status: 'Yhteys',
                openai_status: 'OpenAI',
                grid_view: 'Ruudukko',
                list_view: 'Lista',
                search_products: 'Hae tuotteita...',
                newest: 'Uusimmat ensin',
                oldest: 'Vanhimmat ensin',
                valued: 'Arvostetuimmat',
                price_high: 'Korkein arvo',
                price_low: 'Matalin arvo',
                actions: 'Toiminnot',
                products_over_time: 'Tuotteet ajan my√∂t√§',
                value_distribution: 'Arvojen jakauma',
                detailed_statistics: 'Yksityiskohtaiset tilastot',
                avg_value: 'Keskiarvo',
                highest_value: 'Korkein arvo',
                most_common_location: 'Yleisin sijainti',
                success_rate: 'Arvostusprosentti',
                loading: 'Ladataan...',
                subtitle: 'Seurataan ilmaisia tuotteita Tori.fi palvelusta',
                total_items: 'Tuotteita yhteens√§:',
                last_updated: 'Viimeksi p√§ivitetty:',
                never: 'Ei koskaan',
                auto_refresh: 'Automaattip√§ivitys:',
                run_valuations: 'ü§ñ Suorita arvostukset',
                fetch_images: 'üñºÔ∏è Hae kuvat',
                images: 'Kuvat',
                title: 'Otsikko',
                description: 'Kuvaus',
                location: 'Sijainti',
                seller: 'Myyj√§',
                valuation: 'Arvostus',
                added: 'Lis√§tty',
                link: 'Linkki',
                loading_products: 'Ladataan tuotteita...',
                no_products: 'Tuotteita ei l√∂ytynyt viel√§. Botti aloittaa seurannan pian.',
                bot_settings: 'Botin asetukset',
                general_settings: 'Yleiset asetukset',
                language: 'Kieli:',
                poll_interval: 'Tarkistusv√§li (sekunnit):',
                poll_interval_desc: 'Kuinka usein tarkistetaan uusia tuotteita (min: 10s)',
                request_timeout: 'Pyynt√∂jen aikakatkaisu (sekunnit):',
                max_retries: 'Uudelleenyritysten maksimim√§√§r√§:',
                listing_url: 'Listauksen URL:',
                image_settings: 'Kuvien asetukset',
                enable_image_download: 'Aktivoi kuvien lataus',
                max_images: 'Kuvia tuotetta kohden enint√§√§n:',
                openai_settings: 'OpenAI asetukset',
                enable_valuations: 'Aktivoi OpenAI arvostukset',
                api_key: 'API-avain:',
                api_key_desc: 'Tallennetaan turvallisesti settings.json tiedostoon',
                model: 'Malli:',
                base_url: 'Perus-URL:',
                valuation_interval: 'Arvostusv√§li (minuutit):',
                valuation_interval_desc: 'Kuinka usein automaattiset arvostukset suoritetaan',
                server_settings: 'Palvelimen asetukset',
                host: 'Is√§nt√§:',
                port: 'Portti:',
                restart_required: 'Vaatii uudelleenk√§ynnistyksen',
                save_settings: 'üíæ Tallenna asetukset',
                reload_settings: 'üîÑ Lataa asetukset uudelleen',
                view: 'N√§yt√§',
                no_images: 'Ei kuvia',
                logo_settings: 'Logon asetukset',
                logo_file: 'Logotiedosto:',
                logo_file_desc: 'Valitse taustakuvaksi k√§ytett√§v√§ logo (.png, .jpg, .svg)',
                logo_url: 'Tai anna kuvan URL-osoite:',
                logo_url_desc: 'Lataa logo suoraan URL-osoitteesta',
                load_url: 'üì• Lataa',
                logo_opacity: 'L√§pin√§kyvyys:',
                logo_blur: 'Sumennus:',
                logo_position: 'Sijainti:',
                logo_size: 'Koko:',
                center: 'Keskell√§',
                top_left: 'Vasemmalla ylh√§√§ll√§',
                top_right: 'Oikealla ylh√§√§ll√§',
                bottom_left: 'Vasemmalla alhaalla',
                bottom_right: 'Oikealla alhaalla',
                contain: 'Mahtuu kokonaan',
                cover: 'Peitt√§√§ alueen',
                small: 'Pieni (50%)',
                medium: 'Keskikokoinen (75%)',
                large: 'Suuri (100%)',
                clear_logo: 'üóëÔ∏è Poista logo',
                tori_login_settings: 'Tori.fi kirjautuminen',
                enable_tori_login: 'Aktivoi automaattinen kirjautuminen',
                tori_login_desc: 'Botin kirjautuminen Tori.fi-palveluun parantaa hakutuloksia',
                tori_username: 'K√§ytt√§j√§tunnus/S√§hk√∂posti:',
                tori_username_desc: 'Tori.fi-tilisi k√§ytt√§j√§tunnus tai s√§hk√∂postiosoite',
                tori_password: 'Salasana:',
                tori_password_desc: 'Tori.fi-tilisi salasana (tallennetaan turvallisesti)',
                remember_session: 'Muista kirjautuminen',
                remember_session_desc: 'S√§√§st√§√§ istunnon uudelleenk√§ytt√∂√§ varten',
                test_login: 'üß™ Testaa kirjautuminen',
                test_login_desc: 'Testaa kirjautumistiedot ennen tallennusta',
                telegram_settings: 'Telegram-ilmoitukset',
                enable_telegram: 'Aktivoi Telegram-ilmoitukset',
                telegram_desc: 'L√§het√§ ilmoitus Telegramiin kun uusi tuote l√∂ytyy',
                telegram_token: 'Bot Token:',
                telegram_token_desc: 'Luo bot @BotFatherissa ja kopioi token t√§h√§n',
                telegram_chat_id: 'Chat ID:',
                telegram_chat_desc: 'Kanavan, ryhm√§n tai henkil√∂kohtaisen chatin tunniste',
                telegram_include_images: 'Sis√§llyt√§ kuvat ilmoituksiin',
                test_telegram: 'üß™ Testaa Telegram-yhteys',
                test_telegram_desc: 'L√§het√§ testivesti Telegramiin'
            },
            en: {
                dashboard: 'Kojelauta',
                products: 'Tuotteet',
                products_list: 'Liistan√§kym√§',
                analytics: 'Analytiikka',
                settings: 'Asetukset',
                refresh: 'P√§ivit√§',
                total_products: 'Tuotteita yhteens√§',
                valued_products: 'Arvostettuja tuotteita',
                total_estimated_value: 'Arvioitu kokonaisarvo',
                total_images: 'Kuvia ladattu',
                quick_actions: 'Pikavalinnat',
                logs: 'Logit',
                view_logs: 'N√§yt√§ logit',
                clear_logs: 'Tyhjenn√§ logit',
                logs_description: 'Botin toiminta ja tapahtumat',
                real_time_logs: 'Reaaliaikaiset logit',
                export_data: 'Vie tiedot',
                clear_old: 'Poista vanhat',
                recent_products: 'Viimeisimm√§t tuotteet',
                system_status: 'J√§rjestelm√§n tila',
                bot_status: 'Botin tila',
                connection_status: 'Yhteys',
                openai_status: 'OpenAI',
                grid_view: 'Ruudukko',
                list_view: 'Lista',
                search_products: 'Hae tuotteita...',
                newest: 'Uusimmat ensin',
                oldest: 'Vanhimmat ensin',
                valued: 'Arvostetuimmat',
                price_high: 'Korkein arvo',
                price_low: 'Matalin arvo',
                actions: 'Toiminnot',
                products_over_time: 'Tuotteet ajan my√∂t√§',
                value_distribution: 'Arvojen jakauma',
                detailed_statistics: 'Yksityiskohtaiset tilastot',
                avg_value: 'Keskiarvo',
                highest_value: 'Korkein arvo',
                most_common_location: 'Yleisin sijainti',
                success_rate: 'Arvostusprosentti',
                loading: 'Ladataan...',
                subtitle: 'Seurataan ilmaisia tuotteita Tori.fi palvelusta',
                total_items: 'Tuotteita yhteens√§:',
                last_updated: 'Viimeksi p√§ivitetty:',
                never: 'Ei koskaan',
                auto_refresh: 'Automaattip√§ivitys:',
                run_valuations: 'ü§ñ Suorita arvostukset',
                fetch_images: 'üñºÔ∏è Hae kuvat',
                images: 'Kuvat',
                title: 'Otsikko',
                description: 'Kuvaus',
                location: 'Sijainti',
                seller: 'Myy√§',
                valuation: 'Arvostus',
                added: 'Lis√§tty',
                link: 'Linkki',
                loading_products: 'Ladataan tuotteita...',
                no_products: 'Tuotteita ei l√∂ytynyt viel√§. Botti aloittaa seurannan pian.',
                bot_settings: 'Botin asetukset',
                general_settings: 'Yleiset asetukset',
                language: 'Kieli:',
                poll_interval: 'Tarkistusv√§li (sekunnit):',
                poll_interval_desc: 'Kuinka usein tarkistetaan uusia tuotteita (min: 10s)',
                request_timeout: 'Pyynt√∂jen aikakatkaisu (sekunnit):',
                max_retries: 'Uudelleenyritysten maksimim√§√§r√§:',
                listing_url: 'Listauksen URL:',
                image_settings: 'Kuvien asetukset',
                enable_image_download: 'Aktivoi kuvien lataus',
                max_images: 'Kuvia tuotetta kohden enint√§√§n:',
                openai_settings: 'OpenAI asetukset',
                enable_valuations: 'Aktivoi OpenAI arvostukset',
                api_key: 'API-avain:',
                api_key_desc: 'Tallennetaan turvallisesti settings.json tiedostoon',
                model: 'Malli:',
                base_url: 'Perus-URL:',
                valuation_interval: 'Arvostusv√§li (minuutit):',
                valuation_interval_desc: 'Kuinka usein automaattiset arvostukset suoritetaan',
                server_settings: 'Palvelimen asetukset',
                host: 'Is√§nt√§:',
                port: 'Portti:',
                restart_required: 'Vaatii uudelleenk√§ynnistyksen',
                save_settings: 'üíæ Tallenna asetukset',
                reload_settings: 'üîÑ Lataa asetukset uudelleen',
                view: 'N√§yt√§',
                no_images: 'Ei kuvia',
                logo_settings: 'Logon asetukset',
                logo_file: 'Logotiedosto:',
                logo_file_desc: 'Valitse taustakuvaksi k√§ytett√§v√§ logo (.png, .jpg, .svg)',
                logo_url: 'Tai anna kuvan URL-osoite:',
                logo_url_desc: 'Lataa logo suoraan URL-osoitteesta',
                load_url: 'üì• Lataa',
                logo_opacity: 'L√§pin√§kyvyys:',
                logo_blur: 'Sumennus:',
                logo_position: 'Sijainti:',
                logo_size: 'Koko:',
                center: 'Kesk√§ll√§',
                top_left: 'Vasemmalla ylh√§√§ll√§',
                top_right: 'Oikealla ylh√§√§ll√§',
                bottom_left: 'Vasemmalla alhaalla',
                bottom_right: 'Oikealla alhaalla',
                contain: 'Mahtuu kokonaan',
                cover: 'Peitt√§√§ alueen',
                small: 'Pieni (50%)',
                medium: 'Keskikokoinen (75%)',
                large: 'Suuri (100%)',
                clear_logo: 'üóëÔ∏è Poista logo',
                tori_login_settings: 'Tori.fi kirjautuminen',
                enable_tori_login: 'Aktivoi automaattinen kirjautuminen',
                tori_login_desc: 'Botin kirjautuminen Tori.fi-palveluun parantaa hakutuloksia',
                tori_username: 'K√§ytt√§j√§tunnus/S√§hk√∂posti:',
                tori_username_desc: 'Tori.fi-tilisi k√§ytt√§j√§tunnus tai s√§hk√∂postiosoite',
                tori_password: 'Salasana:',
                tori_password_desc: 'Tori.fi-tilisi salasana (tallennetaan turvallisesti)',
                remember_session: 'Muista kirjautuminen',
                remember_session_desc: 'S√§√§st√§√§ istunnon uudelleenk√§ytt√∂√§ varten',
                test_login: 'üß™ Testaa kirjautuminen',
                test_login_desc: 'Testaa kirjautumistiedot ennen tallennusta',
                telegram_settings: 'Telegram-ilmoitukset',
                enable_telegram: 'Aktivoi Telegram-ilmoitukset',
                telegram_desc: 'L√§het√§ ilmoitus Telegramiin kun uusi tuote l√∂ytyy',
                telegram_token: 'Bot Token:',
                telegram_token_desc: 'Luo bot @BotFatherissa ja kopioi token t√§h√§n',
                telegram_chat_id: 'Chat ID:',
                telegram_chat_desc: 'Kanavan, ryhm√§n tai henkil√∂kohtaisen chatin tunniste',
                telegram_include_images: 'Sis√§llyt√§ kuvat ilmoituksiin',
                test_telegram: 'üß™ Testaa Telegram-yhteys',
                test_telegram_desc: 'L√§het√§ testivesti Telegramiin'
            }
        };
        
        // Dashboard functions
        async function loadDashboard() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();
                
                if (data.success) {
                    allProducts = data.products;
                    updateDashboardStats(allProducts);
                    displayRecentProducts(allProducts.slice(0, 6));
                    updateSystemStatus();
                    
                    const locale = currentLanguage === 'fi' ? 'fi-FI' : 'en-US';
                    document.getElementById('last-update-time').textContent = new Date().toLocaleTimeString(locale);
                    
                    // Initialize logs if on dashboard
                    if (currentPage === 'dashboard') {
                        initializeLogs();
                    }
                } else {
                    showError('Failed to load dashboard data');
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Error loading dashboard');
            }
        }
        
        function updateDashboardStats(products) {
            const totalProducts = products.length;
            const valuedProducts = products.filter(p => p.valuation?.status === 'completed').length;
            const totalImages = products.reduce((sum, p) => sum + (p.image_files?.length || 0), 0);
            
            let totalValue = 0;
            products.forEach(p => {
                if (p.valuation?.price_estimate) {
                    totalValue += p.valuation.price_estimate;
                }
            });
            
            document.getElementById('total-products').textContent = totalProducts;
            document.getElementById('valued-products').textContent = valuedProducts;
            document.getElementById('total-value').textContent = totalValue + '‚Ç¨';
            document.getElementById('total-images').textContent = totalImages;
        }
        
        function displayRecentProducts(products) {
            const container = document.getElementById('recent-products-list');
            container.innerHTML = '';
            
            if (products.length === 0) {
                container.innerHTML = '<div class="no-products"><i class="fas fa-inbox"></i><span data-i18n="no_products">Ei tuotteita viel√§</span></div>';
                return;
            }
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-preview-card';
                
                // Create image element safely
                const previewImage = document.createElement('div');
                previewImage.className = 'preview-image';
                
                const img = document.createElement('img');
                const image = product.image_files && product.image_files[0] 
                    ? `/images/${product.image_files[0]}` 
                    : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23e0e0e0"/><text x="50" y="50" text-anchor="middle" dy=".3em" fill="%23999">üì¶</text></svg>';
                
                img.src = image;
                img.alt = product.title || 'Product';
                img.onerror = () => {
                    img.style.display = 'none';
                    noImageDiv.style.display = 'flex';
                };
                
                const noImageDiv = document.createElement('div');
                noImageDiv.className = 'no-image';
                noImageDiv.style.display = 'none';
                noImageDiv.innerHTML = '<i class="fas fa-image"></i>';
                
                previewImage.appendChild(img);
                previewImage.appendChild(noImageDiv);
                
                // Create content safely
                const previewContent = document.createElement('div');
                previewContent.className = 'preview-content';
                
                const title = document.createElement('h4');
                title.textContent = product.title || 'Ei otsikkoa';
                previewContent.appendChild(title);
                
                const locationP = document.createElement('p');
                locationP.className = 'preview-location';
                locationP.innerHTML = '<i class="fas fa-map-marker-alt"></i> ';
                locationP.appendChild(document.createTextNode(product.location || 'Ei sijaintia'));
                previewContent.appendChild(locationP);
                
                if (product.valuation?.price_estimate) {
                    const valueP = document.createElement('p');
                    valueP.className = 'preview-value';
                    valueP.innerHTML = '<i class="fas fa-euro-sign"></i> ';
                    valueP.appendChild(document.createTextNode(product.valuation.price_estimate + '‚Ç¨'));
                    previewContent.appendChild(valueP);
                }
                
                productCard.appendChild(previewImage);
                productCard.appendChild(previewContent);
                
                productCard.addEventListener('click', () => {
                    window.open(product.url, '_blank');
                });
                
                container.appendChild(productCard);
            });
        }
        
        function updateSystemStatus() {
            // These would be updated with real status checks
            document.getElementById('bot-status').textContent = 'K√§ynniss√§';
            document.getElementById('connection-status').textContent = 'Toimii';
            
            // Check OpenAI status from settings
            const settings = JSON.parse(localStorage.getItem('lastSettings') || '{}');
            const openaiEnabled = settings.openai?.enabled && settings.openai?.api_key;
            document.getElementById('openai-status').textContent = openaiEnabled ? 'Aktiivinen' : 'Pois k√§yt√∂st√§';
        }
        
        let logsIntervalId;

        // Real-time logs functionality
        function initializeLogs() {
            // Simulate real-time log updates
            updateLogs();
            
            // Refresh logs every 5 seconds, avoid creating multiple intervals
            if (logsIntervalId) {
                clearInterval(logsIntervalId);
            }
            logsIntervalId = setInterval(updateLogs, 5000);
            
            // Event listeners for log controls
            const clearLogsBtn = document.getElementById('clear-logs-btn');
            const refreshLogsBtn = document.getElementById('refresh-logs-btn');
            
            if (clearLogsBtn && !clearLogsBtn.dataset.listenerAttached) {
                clearLogsBtn.addEventListener('click', clearLogs);
                clearLogsBtn.dataset.listenerAttached = 'true';
            }
            
            if (refreshLogsBtn && !refreshLogsBtn.dataset.listenerAttached) {
                refreshLogsBtn.addEventListener('click', updateLogs);
                refreshLogsBtn.dataset.listenerAttached = 'true';
            }
        }
        
        function updateLogs() {
            const logsContainer = document.getElementById('logs-container');
            if (!logsContainer) return;
            
            const now = new Date();
            const timestamp = now.toLocaleTimeString('fi-FI');
            
            // Simulate different log types based on current state
            const logTypes = [
                { level: 'INFO', color: 'log-info', message: 'Tarkistetaan uusia tuotteita Tori.fi:st√§...' },
                { level: 'INFO', color: 'log-info', message: `L√∂ydettiin ${allProducts.length} tuotetta yhteens√§` },
                { level: 'INFO', color: 'log-info', message: 'Yhteys Tori.fi palvelimeen toimii' }
            ];
            
            // Add a random log entry occasionally
            if (Math.random() < 0.3) {
                const randomLog = logTypes[Math.floor(Math.random() * logTypes.length)];
                
                const existingNotes = logsContainer.querySelectorAll('.log-note');
                const logLine = document.createElement('div');
                logLine.className = 'log-line';

                const timestampSpan = document.createElement('span');
                timestampSpan.className = 'log-timestamp';
                timestampSpan.textContent = `[${timestamp}]`;

                const levelSpan = document.createElement('span');
                levelSpan.className = `log-level ${randomLog.color}`;
                levelSpan.textContent = `[${randomLog.level}]`;

                const messageSpan = document.createElement('span');
                messageSpan.className = 'log-message';
                messageSpan.textContent = randomLog.message;

                logLine.appendChild(timestampSpan);
                logLine.appendChild(levelSpan);
                logLine.appendChild(messageSpan);
                
                // Insert before the notes
                if (existingNotes.length > 0) {
                    logsContainer.insertBefore(logLine, existingNotes[0]);
                } else {
                    logsContainer.appendChild(logLine);
                }
                
                // Keep only last 10 log lines
                const allLogLines = () => logsContainer.querySelectorAll('.log-line');
                while (allLogLines().length > 10) {
                    allLogLines()[0].remove();
                }
                
                // Auto-scroll to bottom
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        }
        
        function clearLogs() {
            const logsContainer = document.getElementById('logs-container');
            if (!logsContainer) return;
            
            // Remove all log lines but keep the notes
            const logLines = logsContainer.querySelectorAll('.log-line');
            logLines.forEach(line => line.remove());
            
            // Add a clear message
            const clearMessage = document.createElement('div');
            clearMessage.className = 'log-line';
            clearMessage.innerHTML = `
                <span class="log-timestamp">[${new Date().toLocaleTimeString('fi-FI')}]</span>
                <span class="log-level log-info">[INFO]</span>
                <span class="log-message">Logit tyhjennetty k√§ytt√§j√§n toimesta</span>
            `;
            
            const notes = logsContainer.querySelectorAll('.log-note');
            if (notes.length > 0) {
                logsContainer.insertBefore(clearMessage, notes[0]);
            } else {
                logsContainer.appendChild(clearMessage);
            }
        }
        
        function setLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            // Update select option texts
            document.querySelectorAll('[data-i18n-option]').forEach(option => {
                const key = option.getAttribute('data-i18n-option');
                if (translations[lang] && translations[lang][key]) {
                    option.textContent = translations[lang][key];
                }
            });
            
            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[lang] && translations[lang][key]) {
                   load and refresh
        function refreshCurrentPage() {
            loadPageData(currentPage);
        }
        
        document.getElementById('refresh-btn').addEventListener('click', refreshCurrentPage);
        
        // Add remaining product view functions (simplified for now)
        function loadProductsGrid() {
            // Grid view implementation
            loadProducts().then(() => {
                displayProductsGrid(allProducts);
            });
        }
        
        function loadProductsList() {
            // List view implementation  
            loadProducts().then(() => {
                displayProductsList(allProducts);
            });
        }
        
        function loadAnalytics() {
            // Analytics implementation
            if (allProducts.length === 0) {
                loadProducts().then(() => {
                    updateAnalytics(allProducts);
                });
            } else {
                updateAnalytics(allProducts);
            }
        }
        
        function displayProductsGrid(products) {
            const container = document.getElementById('products-grid');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (products.length === 0) {
                container.innerHTML = '<div class="no-products"><i class="fas fa-inbox"></i><span>Ei tuotteita</span></div>';
                return;
            }
            
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                
                // Create elements safely
                const productImage = document.createElement('div');
                productImage.className = 'product-image';
                
                if (product.image_files && product.image_files[0]) {
                    const img = document.createElement('img');
                    img.src = `/images/${product.image_files[0]}`;
                    img.alt = product.title || 'Product';
                    productImage.appendChild(img);
                } else {
                    const noImage = document.createElement('div');
                    noImage.className = 'no-image';
                    noImage.innerHTML = '<i class="fas fa-image"></i>';
                    productImage.appendChild(noImage);
                }
                
                const productInfo = document.createElement('div');
                productInfo.className = 'product-info';
                
                const title = document.createElement('h3');
                title.textContent = product.title || 'Ei otsikkoa';
                productInfo.appendChild(title);
                
                const location = document.createElement('p');
                location.className = 'location';
                location.innerHTML = '<i class="fas fa-map-marker-alt"></i> ';
                location.appendChild(document.createTextNode(product.location || 'Ei sijaintia'));
                productInfo.appendChild(location);
                
                if (product.valuation?.price_estimate) {
                    const value = document.createElement('p');
                    value.className = 'value';
                    value.innerHTML = '<i class="fas fa-euro-sign"></i> ';
                    value.appendChild(document.createTextNode(product.valuation.price_estimate + '‚Ç¨'));
                    productInfo.appendChild(value);
                }
                
                const viewBtn = document.createElement('a');
                viewBtn.href = product.url;
                viewBtn.target = '_blank';
                viewBtn.className = 'view-btn';
                viewBtn.innerHTML = '<i class="fas fa-external-link-alt"></i> N√§yt√§';
                productInfo.appendChild(viewBtn);
                
                card.appendChild(productImage);
                card.appendChild(productInfo);
                container.appendChild(card);
            });
        }
        
        function displayProductsList(products) {
            displayProducts(products); // Use existing function
        }
        
        function updateAnalytics(products) {
            const valued = products.filter(p => p.valuation?.price_estimate);
            const avgValue = valued.length > 0 
                ? Math.round(valued.reduce((sum, p) => sum + p.valuation.price_estimate, 0) / valued.length)
                : 0;
            const maxValue = valued.length > 0 
                ? Math.max(...valued.map(p => p.valuation.price_estimate))
                : 0;
            
            document.getElementById('avg-value').textContent = avgValue + '‚Ç¨';
            document.getElementById('highest-value').textContent = maxValue + '‚Ç¨';
            
            // Most common location
            const locations = products.map(p => p.location).filter(l => l);
            const locationCounts = {};
            locations.forEach(loc => locationCounts[loc] = (locationCounts[loc] || 0) + 1);
            const mostCommon = Object.keys(locationCounts).reduce((a, b) => locationCounts[a] > locationCounts[b] ? a : b, '-');
            document.getElementById('common-location').textContent = mostCommon;
            
            // Success rate
            const successRate = products.length > 0 ? Math.round((valued.length / products.length) * 100) : 0;
            document.getElementById('success-rate').textContent = successRate + '%';
        }
        
        // Initialize dashboard
        showPage('dashboard');
        
        // Update page title if on current page
        if (currentPage) {
            const title = document.getElementById('page-title');
            const key = currentPage.replace('-', '_');
            if (translations[currentLanguage][key]) {
                title.textContent = translations[currentLanguage][key];
            }
        }
        
        localStorage.setItem('language', currentLanguage);
    }
    
    // Load saved language preference
    const savedLanguage = localStorage.getItem('language') || 'fi';
    document.getElementById('language-select').value = savedLanguage;
    document.getElementById('language-select-sidebar').value = savedLanguage;
    setLanguage(savedLanguage);
    
    // Language selector event listeners
    document.getElementById('language-select').addEventListener('change', (e) => {
        setLanguage(e.target.value);
        document.getElementById('language-select-sidebar').value = e.target.value;
    });
    
    document.getElementById('language-select-sidebar').addEventListener('change', (e) => {
        setLanguage(e.target.value);
        document.getElementById('language-select').value = e.target.value;
    });
        
        // Language change events
        [document.getElementById('language-select'), document.getElementById('language-select-sidebar')].forEach(select => {
            if (select) {
                select.addEventListener('change', (e) => {
                    setLanguage(e.target.value);
                    // Sync both selectors
                    [document.getElementById('language-select'), document.getElementById('language-select-sidebar')].forEach(s => {
                        if (s && s !== e.target) s.value = e.target.value;
                    });
                });
            }
        });
        
        // Logo functionality
        const logoElement = document.getElementById('background-logo');
        const opacitySlider = document.getElementById('logo-opacity');
        const blurSlider = document.getElementById('logo-blur');
        const positionSelect = document.getElementById('logo-position');
        const sizeSelect = document.getElementById('logo-size');
        const logoFileInput = document.getElementById('logo-file');
        const logoUrlInput = document.getElementById('logo-url');
        const loadUrlBtn = document.getElementById('load-logo-url-btn');
        const opacityValue = document.getElementById('opacity-value');
        const blurValue = document.getElementById('blur-value');
        
        // Load saved logo settings
        function loadLogoSettings() {
            const logoSettings = JSON.parse(localStorage.getItem('logoSettings') || '{}');
            
            if (logoSettings.opacity !== undefined) {
                opacitySlider.value = logoSettings.opacity;
                opacityValue.textContent = logoSettings.opacity;
            }
            
            if (logoSettings.blur !== undefined) {
                blurSlider.value = logoSettings.blur;
                blurValue.textContent = logoSettings.blur + 'px';
            }
            
            if (logoSettings.position) {
                positionSelect.value = logoSettings.position;
            }
            
            if (logoSettings.size) {
                sizeSelect.value = logoSettings.size;
            }
            
            if (logoSettings.imageData) {
                logoElement.style.backgroundImage = `url(${logoSettings.imageData})`;
                logoElement.classList.add('has-image');
            } else {
                logoElement.classList.remove('has-image');
            }
            
            updateLogoStyle();
        }
        
        // Update logo style
        function updateLogoStyle() {
            const opacity = opacitySlider.value;
            const blur = blurSlider.value;
            const position = positionSelect.value;
            const size = sizeSelect.value;
            
            logoElement.style.opacity = opacity;
            logoElement.style.filter = `blur(${blur}px)`;
            logoElement.style.backgroundPosition = position;
            logoElement.style.backgroundSize = size;
        }
        
        // Save logo settings
        function saveLogoSettings() {
            const backgroundImage = logoElement.style.backgroundImage;
            const imageData = backgroundImage ? backgroundImage.match(/url\(["']?([^"']*)["']?\)/)?.[1] || '' : '';
            
            const logoSettings = {
                opacity: opacitySlider.value,
                blur: blurSlider.value,
                position: positionSelect.value,
                size: sizeSelect.value,
                imageData: imageData
            };
            
            localStorage.setItem('logoSettings', JSON.stringify(logoSettings));
            console.log('Logo settings saved:', logoSettings);
        }
        
        // Event listeners for logo controls
        opacitySlider.addEventListener('input', () => {
            opacityValue.textContent = opacitySlider.value;
            updateLogoStyle();
            saveLogoSettings();
        });
        
        blurSlider.addEventListener('input', () => {
            blurValue.textContent = blurSlider.value + 'px';
            updateLogoStyle();
            saveLogoSettings();
        });
        
        positionSelect.addEventListener('change', () => {
            updateLogoStyle();
            saveLogoSettings();
        });
        
        sizeSelect.addEventListener('change', () => {
            updateLogoStyle();
            saveLogoSettings();
        });
        
        logoFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    const errorMsg = currentLanguage === 'fi' ? 
                        'Valitse kelvollinen kuvatiedosto (.png, .jpg, .gif, .svg)' : 
                        'Please select a valid image file (.png, .jpg, .gif, .svg)';
                    alert(errorMsg);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imageData = e.target.result;
                        logoElement.style.backgroundImage = `url(${imageData})`;
                        logoElement.classList.add('has-image');
                        updateLogoStyle();
                        saveLogoSettings();
                        
                        const successMsg = currentLanguage === 'fi' ? 
                            'Logo ladattu onnistuneesti!' : 
                            'Logo uploaded successfully!';
                        console.log(successMsg);
                    } catch (error) {
                        console.error('Error loading image:', error);
                        const errorMsg = currentLanguage === 'fi' ? 
                            'Virhe kuvan latauksessa' : 
                            'Error loading image';
                        alert(errorMsg);
                    }
                };
                reader.onerror = () => {
                    const errorMsg = currentLanguage === 'fi' ? 
                        'Virhe tiedoston lukemisessa' : 
                        'Error reading file';
                    alert(errorMsg);
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Load logo from URL
        loadUrlBtn.addEventListener('click', async () => {
            const url = logoUrlInput.value.trim();
            
            if (!url) {
                const errorMsg = currentLanguage === 'fi' ? 
                    'Anna kelvollinen URL-osoite' : 
                    'Please enter a valid URL';
                alert(errorMsg);
                return;
            }
            
            if (!url.startsWith('https://') && !url.startsWith('http://')) {
                const errorMsg = currentLanguage === 'fi' ? 
                    'URL-osoitteen tulee alkaa http:// tai https://' : 
                    'URL must start with http:// or https://';
                alert(errorMsg);
                return;
            }
            
            const originalText = loadUrlBtn.textContent;
            const loadingText = currentLanguage === 'fi' ? '‚è≥ Ladataan...' : '‚è≥ Loading...';
            
            loadUrlBtn.disabled = true;
            loadUrlBtn.textContent = loadingText;
            
            try {
                // Use proxy approach for CORS issues
                const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    throw new Error('Failed to fetch image');
                }
                
                const blob = await response.blob();
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const imageData = e.target.result;
                    logoElement.style.backgroundImage = `url(${imageData})`;
                    logoElement.classList.add('has-image');
                    updateLogoStyle();
                    saveLogoSettings();
                    
                    const successMsg = currentLanguage === 'fi' ? 
                        'Logo ladattu URL:sta onnistuneesti!' : 
                        'Logo loaded from URL successfully!';
                    alert(successMsg);
                    logoUrlInput.value = '';
                    
                    loadUrlBtn.disabled = false;
                    loadUrlBtn.textContent = originalText;
                };
                
                reader.onerror = () => {
                    const errorMsg = currentLanguage === 'fi' ? 
                        'Virhe kuvan k√§sittelyss√§' : 
                        'Error processing image';
                    alert(errorMsg);
                    
                    loadUrlBtn.disabled = false;
                    loadUrlBtn.textContent = originalText;
                };
                
                reader.readAsDataURL(blob);
                
            } catch (error) {
                console.error('Error loading logo from URL:', error);
                
                // Fallback: try direct URL (may work for some images)
                try {
                    logoElement.style.backgroundImage = `url(${url})`;
                    logoElement.classList.add('has-image');
                    updateLogoStyle();
                    saveLogoSettings();
                    
                    const successMsg = currentLanguage === 'fi' ? 
                        'Logo asetettu (ei tallennettu paikallisesti)' : 
                        'Logo set (not saved locally)';
                    alert(successMsg);
                    logoUrlInput.value = '';
                } catch (fallbackError) {
                    const errorMsg = currentLanguage === 'fi' ? 
                        'Kuvan lataus ep√§onnistui. Tarkista URL-osoite.' : 
                        'Failed to load image. Please check the URL.';
                    alert(errorMsg);
                }
                
                loadUrlBtn.disabled = false;
                loadUrlBtn.textContent = originalText;
            }
        });
        loadUrlBtn.addEventListener('click', async () => {
            const url = logoUrlInput.value.trim();
            
            if (!url) {
                const errorMsg = currentLanguage === 'fi' ? 
                    'Anna kelvollinen URL-osoite' : 
                    'Please enter a valid URL';
                alert(errorMsg);
                return;
            }
            
            if (!url.startsWith('https://') && !url.startsWith('http://')) {
                const errorMsg = currentLanguage === 'fi' ? 
                    'URL-osoitteen tulee alkaa http:// tai https://' : 
                    'URL must start with http:// or https://';
                alert(errorMsg);
                return;
            }
            
            const originalText = loadUrlBtn.textContent;
            const loadingText = currentLanguage === 'fi' ? '‚è≥ Ladataan...' : '‚è≥ Loading...';
            
            loadUrlBtn.disabled = true;
            loadUrlBtn.textContent = loadingText;
            
            try {
                // Test if image loads
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = () => {
                    try {
                        // Create canvas to convert to base64
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        ctx.drawImage(img, 0, 0);
                        const imageData = canvas.toDataURL('image/png');
                        
                        logoElement.style.backgroundImage = `url(${imageData})`;
                        logoElement.classList.add('has-image');
                        updateLogoStyle();
                        saveLogoSettings();
                        
                        const successMsg = currentLanguage === 'fi' ? 
                            'Logo ladattu URL:sta onnistuneesti!' : 
                            'Logo loaded from URL successfully!';
                        alert(successMsg);
                        logoUrlInput.value = '';
                    } catch (error) {
                        console.error('Canvas error:', error);
                        // Fallback: use URL directly
                        logoElement.style.backgroundImage = `url(${url})`;
                        logoElement.classList.add('has-image');
                        updateLogoStyle();
                        saveLogoSettings();
                        
                        const successMsg = currentLanguage === 'fi' ? 
                            'Logo ladattu URL:sta!' : 
                            'Logo loaded from URL!';
                        alert(successMsg);
                        logoUrlInput.value = '';
                    }
                    
                    loadUrlBtn.disabled = false;
                    loadUrlBtn.textContent = originalText;
                };
                
                img.onerror = () => {
                    const errorMsg = currentLanguage === 'fi' ? 
                        'Kuvan lataus ep√§onnistui. Tarkista URL-osoite.' : 
                        'Failed to load image. Please check the URL.';
                    alert(errorMsg);
                    
                    loadUrlBtn.disabled = false;
                    loadUrlBtn.textContent = originalText;
                };
                
                img.src = url;
                
            } catch (error) {
                console.error('Error loading logo from URL:', error);
                const errorMsg = currentLanguage === 'fi' ? 
                    'Virhe kuvan latauksessa URL:sta' : 
                    'Error loading image from URL';
                alert(errorMsg);
                
                loadUrlBtn.disabled = false;
                loadUrlBtn.textContent = originalText;
            }
        });
        
        // Clear logo button
        document.getElementById('clear-logo-btn').addEventListener('click', () => {
            logoElement.style.backgroundImage = '';
            logoElement.classList.remove('has-image');
            logoFileInput.value = '';
            saveLogoSettings();
            
            const successMsg = currentLanguage === 'fi' ? 
                'Logo poistettu' : 
                'Logo cleared';
            console.log(successMsg);
        });
        
        // Initialize logo settings
        loadLogoSettings();
        
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                switchTab(tab);
            });
        });
        
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `${tab}-tab`);
            });
            if (tab === 'products') loadProducts();
            else if (tab === 'settings') loadSettings();
        }
        
        // Load products
        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();
                
                if (data.success) {
                    displayProducts(data.products);
                    const locale = currentLanguage === 'fi' ? 'fi-FI' : 'en-US';
                    document.getElementById('last-update').textContent = new Date().toLocaleTimeString(locale);
                } else {
                    showError('Failed to load products');
                }
            } catch (error) {
                console.error('Error loading products:', error);
                const errorMsg = currentLanguage === 'fi' ? 'Virhe tuotteiden latauksessa. Tarkista, ett√§ palvelin on k√§ynniss√§.' : 'Error loading products. Check if server is running.';
                showError(errorMsg);
            }
        }

        // Fetch products from Tori.fi
        async function fetchToriProducts() {
            const btn = document.getElementById('fetch-btn');
            const originalText = btn ? btn.textContent : '';
            
            try {
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = currentLanguage === 'fi' ? 'Haetaan...' : 'Fetching...';
                }
                
                const response = await fetch('/api/fetch', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    loadProducts(); // Reload products after fetch
                    const message = currentLanguage === 'fi' ? 
                        `Haettu ${result.count || 0} tuotetta onnistuneesti!` : 
                        `Successfully fetched ${result.count || 0} products!`;
                    showMessage(message, 'success');
                } else {
                    const errorMsg = result.error || (currentLanguage === 'fi' ? 'Haku ep√§onnistui' : 'Fetch failed');
                    showMessage(errorMsg, 'error');
                }
            } catch (error) {
                console.error('Error fetching products:', error);
                const errorMsg = currentLanguage === 'fi' ? 'Virhe tuotteiden haussa' : 'Error fetching products';
                showMessage(errorMsg, 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            }
        }

        // Save products to CSV
        async function saveToriProducts() {
            const btn = document.getElementById('save-btn');
            const originalText = btn ? btn.textContent : '';
            
            try {
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = currentLanguage === 'fi' ? 'Tallennetaan...' : 'Saving...';
                }
                
                const response = await fetch('/api/save', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    const message = currentLanguage === 'fi' ? 
                        `Tallennettu ${result.filename}` : 
                        `Saved as ${result.filename}`;
                    showMessage(message, 'success');
                } else {
                    const errorMsg = result.error || (currentLanguage === 'fi' ? 'Tallennus ep√§onnistui' : 'Save failed');
                    showMessage(errorMsg, 'error');
                }
            } catch (error) {
                console.error('Error saving products:', error);
                const errorMsg = currentLanguage === 'fi' ? 'Virhe tuotteiden tallennuksessa' : 'Error saving products';
                showMessage(errorMsg, 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            }
        }

        // Show message function
        function showMessage(message, type) {
            // Try to find an existing message area or create one
            let messageEl = document.getElementById('message-area');
            if (!messageEl) {
                messageEl = document.createElement('div');
                messageEl.id = 'message-area';
                messageEl.style.cssText = `
                    position: fixed; 
                    top: 20px; 
                    right: 20px; 
                    padding: 15px 20px; 
                    border-radius: 8px; 
                    color: white; 
                    font-weight: bold; 
                    z-index: 10000; 
                    min-width: 300px; 
                    text-align: center;
                    transition: all 0.3s ease;
                `;
                document.body.appendChild(messageEl);
            }
            
            messageEl.textContent = message;
            messageEl.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
            messageEl.style.display = 'block';
            messageEl.style.opacity = '1';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageEl.style.opacity = '0';
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.parentNode.removeChild(messageEl);
                    }
                }, 300);
            }, 5000);
        }
        
        // Display products
        function displayProducts(products) {
            const tbody = document.getElementById('products-body');
            const noProducts = document.getElementById('no-products');
            const totalCount = document.getElementById('total-count');
            
            totalCount.textContent = products.length;
            
            if (products.length === 0) {
                tbody.innerHTML = '';
                noProducts.style.display = 'block';
                return;
            }
            
            noProducts.style.display = 'none';
            tbody.innerHTML = '';
            
            products.forEach(product => {
                const row = document.createElement('tr');
                
                // Images
                const imagesCell = document.createElement('td');
                imagesCell.className = 'images-cell';
                if (product.image_files && product.image_files.length > 0) {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'image-gallery';
                    product.image_files.forEach((filename, idx) => {
                        if (idx < 3) {
                            const img = document.createElement('img');
                            img.src = `/images/${filename}`;
                            img.className = 'product-thumbnail';
                            img.alt = product.title || 'Product';
                            img.onerror = () => img.style.display = 'none';
                            imgContainer.appendChild(img);
                        }
                    });
                    if (product.image_files.length > 3) {
                        const more = document.createElement('span');
                        more.className = 'more-images';
                        more.textContent = `+${product.image_files.length - 3}`;
                        imgContainer.appendChild(more);
                    }
                    imagesCell.appendChild(imgContainer);
                } else {
                    imagesCell.textContent = translations[currentLanguage].no_images;
                    imagesCell.className = 'images-cell no-images';
                }
                row.appendChild(imagesCell);
                
                // Title
                const titleCell = document.createElement('td');
                titleCell.className = 'title-cell';
                titleCell.textContent = product.title || 'N/A';
                if (product.errors && product.errors.length > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'error-badge';
                    badge.title = product.errors.join(', ');
                    badge.textContent = '‚ö†Ô∏è';
                    titleCell.appendChild(badge);
                }
                row.appendChild(titleCell);
                
                // Description
                const descCell = document.createElement('td');
                descCell.className = 'description-cell';
                descCell.textContent = product.description || 'N/A';
                descCell.title = product.description || '';
                row.appendChild(descCell);
                
                // Location
                const locCell = document.createElement('td');
                locCell.textContent = product.location || 'N/A';
                row.appendChild(locCell);
                
                // Seller
                const sellerCell = document.createElement('td');
                sellerCell.textContent = product.seller || 'N/A';
                row.appendChild(sellerCell);
                
                // Valuation
                const valCell = document.createElement('td');
                valCell.className = 'valuation-cell';
                if (product.valuation) {
                    if (product.valuation.status === 'completed') {
                        const div = document.createElement('div');
                        div.className = 'valuation-text';
                        div.textContent = product.valuation.text;
                        valCell.appendChild(div);
                        
                        // Add price estimate if available
                        if (product.valuation.price_estimate) {
                            const priceDiv = document.createElement('div');
                            priceDiv.className = 'price-estimate';
                            priceDiv.textContent = `Arvio: ${product.valuation.price_estimate}‚Ç¨`;
                            priceDiv.style.fontWeight = 'bold';
                            priceDiv.style.color = '#28a745';
                            priceDiv.style.marginTop = '5px';
                            valCell.appendChild(priceDiv);
                        }
                    } else if (product.valuation.status === 'error') {
                        valCell.textContent = '‚ùå Error';
                        valCell.title = product.valuation.message || 'Unknown error';
                    } else {
                        valCell.textContent = '‚è≥ Pending';
                    }
                } else {
                    valCell.textContent = '‚Äî';
                }
                row.appendChild(valCell);
                
                // Timestamp
                const timeCell = document.createElement('td');
                timeCell.className = 'timestamp-cell';
                if (product.discovered_at) {
                    const date = new Date(product.discovered_at);
                    const locale = currentLanguage === 'fi' ? 'fi-FI' : 'en-US';
                    timeCell.textContent = date.toLocaleString(locale);
                }
                row.appendChild(timeCell);
                
                // Link
                const linkCell = document.createElement('td');
                linkCell.className = 'link-cell';
                const link = document.createElement('a');
                link.href = product.url;
                link.target = '_blank';
                link.textContent = translations[currentLanguage].view;
                link.className = 'view-link';
                linkCell.appendChild(link);
                row.appendChild(linkCell);
                
                tbody.appendChild(row);
            });
        }
        
        // Load settings
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                
                if (data.success) {
                    populateSettings(data.settings);
                } else {
                    const errorMsg = currentLanguage === 'fi' ? 'Asetusten lataus ep√§onnistui' : 'Failed to load settings';
                    showSettingsMessage(errorMsg, 'error');
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                const errorMsg = currentLanguage === 'fi' ? 'Virhe asetusten latauksessa' : 'Error loading settings';
                showSettingsMessage(errorMsg, 'error');
            }
        }
        
        // Populate settings form
        function populateSettings(s) {
            document.getElementById('poll_interval').value = s.poll_interval_seconds || 60;
            document.getElementById('timeout').value = s.request_timeout_seconds || 15;
            document.getElementById('max_retries').value = s.max_retries || 2;
            document.getElementById('listing_url').value = s.listing_url || '';
            
            document.getElementById('images_enabled').checked = s.images?.download_enabled ?? true;
            document.getElementById('max_images').value = s.images?.max_images_per_item || 5;
            
            document.getElementById('openai_enabled').checked = s.openai?.enabled ?? false;
            document.getElementById('openai_model').value = s.openai?.model || 'gpt-4o-mini';
            document.getElementById('openai_base_url').value = s.openai?.base_url || 'https://api.openai.com/v1';
            document.getElementById('valuation_interval').value = s.openai?.valuation_interval_minutes || 60;
            
            document.getElementById('server_host').value = s.server?.host || '127.0.0.1';
            document.getElementById('server_port').value = s.server?.port || 8787;
            
            // Tori login settings
            document.getElementById('tori_login_enabled').checked = s.tori_login?.enabled ?? false;
            document.getElementById('tori_username').value = s.tori_login?.username || '';
            // Don't populate password field for security
            document.getElementById('tori_remember_session').checked = s.tori_login?.remember_session ?? true;
            
            // Telegram settings
            document.getElementById('telegram_enabled').checked = s.telegram?.enabled ?? false;
            document.getElementById('telegram_chat_id').value = s.telegram?.chat_id || '';
            document.getElementById('telegram_include_images').checked = s.telegram?.include_images ?? true;
            // Don't populate token field for security
            
            // Load logo settings are handled separately by loadLogoSettings()
        }
        
        // Save settings
        document.getElementById('save-settings-btn').addEventListener('click', async () => {
            const settings = {
                poll_interval_seconds: parseInt(document.getElementById('poll_interval').value),
                listing_url: document.getElementById('listing_url').value,
                request_timeout_seconds: parseInt(document.getElementById('timeout').value),
                max_retries: parseInt(document.getElementById('max_retries').value),
                openai: {
                    enabled: document.getElementById('openai_enabled').checked,
                    model: document.getElementById('openai_model').value,
                    base_url: document.getElementById('openai_base_url').value,
                    valuation_interval_minutes: parseInt(document.getElementById('valuation_interval').value)
                },
                images: {
                    download_enabled: document.getElementById('images_enabled').checked,
                    max_images_per_item: parseInt(document.getElementById('max_images').value)
                },
                server: {
                    host: document.getElementById('server_host').value,
                    port: parseInt(document.getElementById('server_port').value)
                },
                tori_login: {
                    enabled: document.getElementById('tori_login_enabled').checked,
                    username: document.getElementById('tori_username').value.trim(),
                    remember_session: document.getElementById('tori_remember_session').checked
                },
                telegram: {
                    enabled: document.getElementById('telegram_enabled').checked,
                    chat_id: document.getElementById('telegram_chat_id').value.trim(),
                    include_images: document.getElementById('telegram_include_images').checked
                }
            };
            
            const apiKey = document.getElementById('openai_key').value.trim();
            if (apiKey && apiKey !== '***MASKED***') {
                settings.openai.api_key = apiKey;
            }
            
            const toriPassword = document.getElementById('tori_password').value.trim();
            if (toriPassword && toriPassword !== '') {
                settings.tori_login.password = toriPassword;
            }
            
            const telegramToken = document.getElementById('telegram_token').value.trim();
            if (telegramToken && telegramToken !== '') {
                settings.telegram.token = telegramToken;
            }
            
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const successMsg = currentLanguage === 'fi' ? '‚úÖ Asetukset tallennettu onnistuneesti!' : '‚úÖ Settings saved successfully!';
                    showSettingsMessage(successMsg, 'success');
                    document.getElementById('openai_key').value = '';
                    document.getElementById('tori_password').value = '';
                    document.getElementById('telegram_token').value = '';
                } else {
                    const errorPrefix = currentLanguage === 'fi' ? '‚ùå Ep√§onnistui: ' : '‚ùå Failed: ';
                    showSettingsMessage(errorPrefix + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                const errorMsg = currentLanguage === 'fi' ? '‚ùå Virhe asetusten tallennuksessa' : '‚ùå Error saving settings';
                showSettingsMessage(errorMsg, 'error');
            }
        });
        
        // Test Telegram connection
        document.getElementById('test-telegram-btn').addEventListener('click', async () => {
            const btn = document.getElementById('test-telegram-btn');
            const originalText = btn.textContent;
            const testingText = currentLanguage === 'fi' ? '‚è≥ L√§hetet√§√§n...' : '‚è≥ Sending...';
            
            btn.disabled = true;
            btn.textContent = testingText;
            
            const telegramConfig = {
                token: document.getElementById('telegram_token').value.trim(),
                chat_id: document.getElementById('telegram_chat_id').value.trim()
            };
            
            if (!telegramConfig.token || !telegramConfig.chat_id) {
                const errorMsg = currentLanguage === 'fi' ? 
                    'Sy√∂t√§ Bot Token ja Chat ID ensin' : 
                    'Please enter Bot Token and Chat ID first';
                showSettingsMessage(errorMsg, 'error');
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }
            
            try {
                const response = await fetch('/api/test-telegram', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(telegramConfig)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const successMsg = currentLanguage === 'fi' ? 
                        '‚úÖ Testivesti l√§hetetty onnistuneesti Telegramiin!' : 
                        '‚úÖ Test message sent successfully to Telegram!';
                    showSettingsMessage(successMsg, 'success');
                } else {
                    const errorPrefix = currentLanguage === 'fi' ? '‚ùå Telegram-testi ep√§onnistui: ' : '‚ùå Telegram test failed: ';
                    showSettingsMessage(errorPrefix + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error testing Telegram:', error);
                const errorMsg = currentLanguage === 'fi' ? 
                    '‚ùå Virhe Telegram-yhteydess√§' : 
                    '‚ùå Error testing Telegram connection';
                showSettingsMessage(errorMsg, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });
        
        
        // Reload settings
        document.getElementById('load-settings-btn').addEventListener('click', () => {
            loadSettings();
            const msg = currentLanguage === 'fi' ? 'Asetukset ladattu uudelleen' : 'Settings reloaded';
            showSettingsMessage(msg, 'info');
        });
        
        // Trigger valuation
        document.getElementById('valuate-btn').addEventListener('click', async () => {
            const btn = document.getElementById('valuate-btn');
            btn.disabled = true;
            const runningText = currentLanguage === 'fi' ? '‚è≥ Suoritetaan...' : '‚è≥ Running...';
            const originalText = btn.textContent;
            btn.textContent = runningText;
            
            try {
                const response = await fetch('/api/valuate', {method: 'POST'});
                const data = await response.json();
                
                if (data.success) {
                    const successMsg = currentLanguage === 'fi' ? 
                        '‚úÖ Arvostukset aloitettu! Tarkista tilanne muutaman minuutin kuluttua.' :
                        '‚úÖ Valuations started! Check back in a few minutes.';
                    alert(successMsg);
                } else {
                    const errorPrefix = currentLanguage === 'fi' ? '‚ùå ' : '‚ùå ';
                    alert(errorPrefix + (data.message || data.error || (currentLanguage === 'fi' ? 'Ep√§onnistui' : 'Failed')));
                }
            } catch (error) {
                console.error('Error:', error);
                const errorMsg = currentLanguage === 'fi' ? 
                    '‚ùå Virhe arvostusten k√§ynnist√§misess√§' :
                    '‚ùå Error triggering valuations';
                alert(errorMsg);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });
        
        function showError(message) {
            const tbody = document.getElementById('products-body');
            tbody.innerHTML = `<tr><td colspan="8" class="error">${message}</td></tr>`;
        }
        
        function showSettingsMessage(message, type) {
            const msgEl = document.getElementById('settings-message');
            msgEl.textContent = message;
            msgEl.className = `message ${type}`;
            msgEl.style.display = 'block';
            setTimeout(() => msgEl.style.display = 'none', 5000);
        }
        
        // Dashboard action buttons event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Fetch products button
            const fetchBtn = document.getElementById('fetch-btn');
            if (fetchBtn) {
                fetchBtn.addEventListener('click', fetchToriProducts);
            }
            
            // Save products button
            const saveBtn = document.getElementById('save-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveToriProducts);
            }
            
            // Run valuations button
            const valuateBtn = document.getElementById('run-valuations-dash');
            if (valuateBtn) {
                valuateBtn.addEventListener('click', async () => {
                    const btn = valuateBtn;
                    btn.disabled = true;
                    const runningText = currentLanguage === 'fi' ? '‚è≥ Suoritetaan...' : '‚è≥ Running...';
                    const originalText = btn.textContent;
                    btn.textContent = runningText;
                    
                    try {
                        const response = await fetch('/api/valuate', {method: 'POST'});
                        const data = await response.json();
                        
                        if (data.success) {
                            const successMsg = currentLanguage === 'fi' ? 
                                '‚úÖ Arvostukset aloitettu!' :
                                '‚úÖ Valuations started!';
                            showMessage(successMsg, 'success');
                        } else {
                            const errorMsg = data.message || data.error || (currentLanguage === 'fi' ? 'Ep√§onnistui' : 'Failed');
                            showMessage(errorMsg, 'error');
                        }
                    } catch (error) {
                        console.error('Error starting valuations:', error);
                        const errorMsg = currentLanguage === 'fi' ? 'Virhe arvostusten aloituksessa' : 'Error starting valuations';
                        showMessage(errorMsg, 'error');
                    } finally {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }
                });
            }
            
            // Fetch images button
            const fetchImagesBtn = document.getElementById('fetch-images-dash');
            if (fetchImagesBtn) {
                fetchImagesBtn.addEventListener('click', async () => {
                    const btn = fetchImagesBtn;
                    btn.disabled = true;
                    const runningText = currentLanguage === 'fi' ? '‚è≥ Haetaan...' : '‚è≥ Fetching...';
                    const originalText = btn.textContent;
                    btn.textContent = runningText;
                    
                    try {
                        const response = await fetch('/api/fetch-images', {method: 'POST'});
                        const data = await response.json();
                        
                        if (data.success) {
                            const successMsg = currentLanguage === 'fi' ? 
                                `‚úÖ Haettu ${data.count || 0} kuvaa!` :
                                `‚úÖ Fetched ${data.count || 0} images!`;
                            showMessage(successMsg, 'success');
                        } else {
                            const errorMsg = data.message || data.error || (currentLanguage === 'fi' ? 'Ep√§onnistui' : 'Failed');
                            showMessage(errorMsg, 'error');
                        }
                    } catch (error) {
                        console.error('Error fetching images:', error);
                        const errorMsg = currentLanguage === 'fi' ? 'Virhe kuvien haussa' : 'Error fetching images';
                        showMessage(errorMsg, 'error');
                    } finally {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }
                });
            }
        });
        
        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved language preference
            const savedLanguage = localStorage.getItem('language') || 'fi';
            document.getElementById('language-select').value = savedLanguage;
            document.getElementById('language-select-sidebar').value = savedLanguage;
            setLanguage(savedLanguage);
            
            // Show dashboard by default
            showPage('dashboard');
        });
        
        // Auto-refresh
        setInterval(() => {
            if (currentPage === 'products' || currentPage === 'products-list' || currentPage === 'dashboard') {
                if (currentPage === 'dashboard') {
                    loadDashboard();
                } else {
                    loadProducts();
                }
            }
        }, REFRESH_INTERVAL);
        
        console.log('Tori Annataan Bot GUI loaded. Auto-refresh: 30s');
    </script>
</body>
</html>